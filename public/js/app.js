const h=o=>({el:o,input:{el:null,isNumber:!1,min:null,max:null,step:null},numberOptions:{decimalSeparator:null,thousandsSeparator:null,decimalDigits:0},calculatorShow:!1,formula:"",displayField:null,allowedKeys:"0123456789+-*/(),.%^",operators:"+-*/%^",isMask:!1,init(){this.input.el=o.querySelector("input"),this.input.isNumber=this.input.el.type==="number",this.input.isNumber&&(this.input.min=this.input.el.min,this.input.max=this.input.el.max,this.input.step=this.input.el.step),this.displayField=o.querySelector(".calculator input.formula"),this.el.addEventListener("keydown",this.handleKeyPress.bind(this)),this.calculatorShow=!1,document.addEventListener("click",this.handleOutsideClick.bind(this)),this.mask()},handleOutsideClick(t){!this.el.contains(t.target)&&this.calculatorShow&&this.toggle()},mask(){const t=this.input.el.getAttribute("x-mask"),s=this.input.el.getAttribute("x-mask:dynamic");if(!t&&!s)return null;t&&(this.isMask=this.parseNumberMask(t)),s&&(this.isMask=this.parseMoneyMask(s))},parseNumberMask(t){const s=/\d+|[.,\s]/g,e=t.match(s);if(!e)return!1;let a=!1;const i=[];e.reverse().map((n,u,r)=>{/\d/.test(n)||(i.includes(n)&&!a?a=!0:i.push(n))}),i.length===2?(this.numberOptions.thousandsSeparator=i.pop(),this.numberOptions.decimalSeparator=i.pop()):i.length===1&&!a?this.numberOptions.decimalSeparator=i.pop():i.length===1&&a&&(this.numberOptions.thousandsSeparator=i.pop()),this.numberOptions.decimalDigits=/\d/.test(e[0])?e[0].length:0;const l=this.numberFormatterParse(t);return this.el.max=l??0,!0},numberFormatterParse(t){const{decimalSeparator:s,thousandsSeparator:e}=this.numberOptions,a=t.trim();if(!new RegExp(`^[-]?[\\d${s}${e}]*$`,"g").test(a))return null;const l=a.replace(e,"").replace(s,".");if(l==="")return null;const n=parseFloat(l);return isNaN(n)?null:n},parseMoneyMask(t){const e=/\$money\(\$input,\s*'([^']*(?:''[^']*)*)'\s*(?:,\s*'([^']*(?:''[^']*)*)')?\s*(?:,\s*'([^']*(?:''[^']*)*)')?\s*(?:,\s*(\d+))?\)/g.exec(t);if(!t.includes("money")&&!e)return!1;if(e){const[,a=".",i="",l=2]=e;this.numberOptions={decimalSeparator:a,thousandsSeparator:i,decimalDigits:l}}else this.numberOptions={decimalSeparator:".",thousandsSeparator:"",decimalDigits:2};return!0},toggle(){this.calculatorShow=!this.calculatorShow,this.calculatorShow?(this.formula=this.numberFormatterParse(this.input.el.value)?this.input.el.value.replace(/\s/g,""):this.formula,this.setDisplayFormula()):(this.input.el.value=this.formatValue(this.calculate(this.formula)??0),this.formula="",setTimeout(()=>this.input.el.focus(),10))},keyPress(t){if(this.allowedKeys.includes(t)){this.setFormula(t);return}if(t==="="||t==="Enter"){this.toggle();return}t==="Backspace"&&(this.formula=this.formula.slice(0,-1)),t==="Escape"&&(this.formula=""),this.setDisplayFormula()},setDisplayFormula(){this.displayField.value=this.formula},formatValue(t){if(this.input.isNumber){const s=e=>e.toString().split(".")[1].length||0;return Math.min(Math.max(t.toFixed(s(this.input.step)),this.input.min),this.input.max)}return this.isMask?(this.el.max&&t>this.el.max&&(t=this.el.max),this.numberFormatterFormat(t)):t},numberFormatterFormat(t){const{decimalSeparator:s,thousandsSeparator:e,decimalDigits:a}=this.numberOptions,l=t.toFixed(a).split(".");return l[0]=l[0].replace(/\B(?=(\d{3})+(?!\d))/g,e??""),l.join(s)},setFormula(t){(this.formula===""||this.formula===0)&&this.operators.includes(t)&&t!=="-"||(this.formula+=t,this.setDisplayFormula())},handleKeyPress(t){if(this.calculatorShow){if(t.preventDefault(),t.ctrlKey&&t.altKey&&t.code==="KeyC"){this.toggle();return}this.keyPress(t.key);return}!this.calculatorShow&&t.ctrlKey&&t.altKey&&t.code==="KeyC"&&this.toggle()},calculate(){let t=this.formula.replace(/\s/g,"").replace(/,/g,".");return t===""?null:this.processString(t)},processString(t){let s=t;if(/\(/.test(t)){let e=0,a=-1;for(let i=0;i<t.length;i++){const l=t[i];if(l==="(")a===-1&&(a=i),e++;else if(l===")"&&(e--,e===0)){const n=t.slice(a+1,i),u=this.processString(n);s=s.replace(`(${n})`,u),a=-1}}}return this.evaluate(this.processPercent(s))??0},processPercent(t){const s=/^(.*?)([+\-])(\d+(?:\.\d+)?%(?!\d))/;let e=t;for(;s.test(e);){const a=s.exec(e);if(!a)break;const[i,l]=a;/^-?\d+(?:\.\d+)?$/.test(l)?e=e.replace(i,this.evaluate(i).toString()):(e=e.replace(l,this.evaluate(l).toString()),e=this.processPercent(e))}return e},evaluate(t){return t=t.replace(/\*\*/g,"^"),t=t.replace(/(^-?\d+(?:\.\d+)?)%(\d+(?:\.\d+)?)/g,"($1*0.01*$2)"),t=t.replace(/(^-?\d+(?:\.\d+)?)([+\-])(\d+(?:\.\d+)?)%/g,"($1$2($1*$3*0.01))"),t=t.replace(/(^-?\d+(?:\.\d+)?)(\/)(\d+(?:\.\d+)?)%/g,"$1$2($3*0.01)"),t=t.replace(/(\d+(?:\.\d+)?)%/g,"($1*0.01)"),t=t.replace(/%/g,"*0.01"),this.evaluatePostfix(this.infixToPostfix(t))},infixToPostfix(t){const s={"+":1,"-":1,"*":2,"/":2,"^":2},e=[],a=[];let i=[],l=null;const n=()=>{i.length&&(a.push(i.join("")),i=[])},u=r=>{if(n(),r==="(")e.push(r),l=null;else if(r===")"){for(;e.length&&e[e.length-1]!=="(";)a.push(e.pop());e.pop()}else if(r==="-"&&(l===null||l==="("||l in s))i.push(r);else{for(;e.length&&s[r]<=s[e[e.length-1]];)a.push(e.pop());e.push(r)}l=r};for(const r of t)/[\d\.]/.test(r)?(i.push(r),l=r):r in s&&u(r);for(n();e.length;)a.push(e.pop());return a},evaluatePostfix(t){let s=[];return t.forEach(e=>{if(/^-?\d+(?:\.\d+)?$/.test(e))s.push(parseFloat(e));else{const a=s.pop(),i=s.pop();switch(e){case"+":s.push(i+a);break;case"-":s.push(i-a);break;case"*":s.push(i*a);break;case"/":s.push(i/a);break;case"^":s.push(i**a);break}}}),s.pop()}});document.addEventListener("alpine:init",()=>{Alpine.data("flCalculator",h)});
