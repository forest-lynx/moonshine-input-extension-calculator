const o=n=>({el:n,input:{el:null,isNumber:!1,min:null,max:null,step:null},calculatorShow:!1,formula:"",displayField:null,allowedKeys:"0123456789+-*/(),.%^",operators:"+-*/%^",init(){this.input.el=n.querySelector("input"),this.input.isNumber=this.input.el.type==="number",this.input.isNumber&&(this.input.min=this.input.el.min,this.input.max=this.input.el.max,this.input.step=this.input.el.step),this.displayField=n.querySelector(".calculator input.formula"),this.el.addEventListener("keydown",this.handleKeyPress.bind(this)),this.calculatorShow=!1},toggle(){this.calculatorShow=!this.calculatorShow,this.calculatorShow?(this.formula=this.input.el.value?this.input.el.value.replace(/\s/g,""):this.formula,this.setDisplayFormula()):(this.input.el.value=this.formatValue(this.calculate(this.formula)??0),this.formula="",setTimeout(()=>this.input.el.focus(),10))},keyPress(t){if(this.allowedKeys.includes(t)){this.setFormula(t);return}if(t==="="||t==="Enter"){this.toggle();return}t==="Backspace"&&(this.formula=this.formula.slice(0,-1)),t==="Escape"&&(this.formula=""),this.setDisplayFormula()},setDisplayFormula(){this.displayField.value=this.formula},formatValue(t){if(this.input.isNumber){const l=e=>e.toString().split(".")[1].length||0;return Math.min(Math.max(t.toFixed(l(this.input.step)),this.input.min),this.input.max)}return t},setFormula(t){(this.formula===""||this.formula===0)&&this.operators.includes(t)&&t!=="-"||(this.formula+=t,this.setDisplayFormula())},handleKeyPress(t){if(this.calculatorShow){if(t.preventDefault(),t.ctrlKey&&t.altKey&&t.code==="KeyC"){this.toggle();return}this.keyPress(t.key);return}!this.calculatorShow&&t.ctrlKey&&t.altKey&&t.code==="KeyC"&&this.toggle()},calculate(){let t=this.formula.replace(/\s/g,"").replace(/,/g,".");return t===""?null:this.processString(t)},processString(t){let l=t;if(/\(/.test(t)){let e=0,i=-1;for(let s=0;s<t.length;s++){const u=t[s];if(u==="(")i===-1&&(i=s),e++;else if(u===")"&&(e--,e===0)){const r=t.slice(i+1,s),h=this.processString(r);l=l.replace(`(${r})`,h),i=-1}}}return this.evaluate(this.processPercent(l))??0},processPercent(t){const l=/^(.*?)([+\-])(\d+(?:\.\d+)?%(?!\d))/;let e=t;for(;l.test(e);){const i=l.exec(e);if(!i)break;const[s,u]=i;/^-?\d+(?:\.\d+)?$/.test(u)?e=e.replace(s,this.evaluate(s)):(e=e.replace(u,this.evaluate(u)),e=this.processPercent(e))}return e},evaluate(t){return t=t.replace(/\*\*/g,"^"),t=t.replace(/(^-?\d+(?:\.\d+)?)%(\d+(?:\.\d+)?)/g,"($1*0.01*$2)"),t=t.replace(/(^-?\d+(?:\.\d+)?)([+\-])(\d+(?:\.\d+)?)%/g,"($1$2($1*$3*0.01))"),t=t.replace(/(\d+(?:\.\d+)?)%/g,"($1*0.01)"),t=t.replace(/%/g,"*0.01"),this.evaluatePostfix(this.infixToPostfix(t))},infixToPostfix(t){const l={"+":1,"-":1,"*":2,"/":2,"^":2},e=[],i=[];let s=[],u=null;const r=()=>{s.length&&(i.push(s.join("")),s=[])},h=a=>{if(r(),a==="(")e.push(a),u=null;else if(a===")"){for(;e.length&&e[e.length-1]!=="(";)i.push(e.pop());e.pop()}else if(a==="-"&&(u===null||u==="("||u in l))s.push(a);else{for(;e.length&&l[a]<=l[e[e.length-1]];)i.push(e.pop());e.push(a)}u=a};for(const a of t)/[\d\.]/.test(a)?(s.push(a),u=a):a in l&&h(a);for(r();e.length;)i.push(e.pop());return i},evaluatePostfix(t){let l=[];return t.forEach(e=>{if(/^-?\d+(?:\.\d+)?$/.test(e))l.push(parseFloat(e));else{const i=l.pop(),s=l.pop();switch(e){case"+":l.push(s+i);break;case"-":l.push(s-i);break;case"*":l.push(s*i);break;case"/":l.push(s/i);break;case"^":l.push(s**i);break}}}),l.pop()}});document.addEventListener("alpine:init",()=>{Alpine.data("flCalculator",o)});
